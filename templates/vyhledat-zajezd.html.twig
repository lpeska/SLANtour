{% extends "_base.html.twig" %}

{% block title %}SLANtour - {{ type.name }}{% endblock title %}

{% block stylesheets %}

{% endblock stylesheets %}

{% block main %}

<script src="/node_modules/itemsjs/dist/itemsjs.js"></script>
<section class="hero_in tour_list search">
    <img src="../img/dovolena.png" alt="Slide background">
    <div class="wrapper">
</section>
<!--/hero_in-->

<div class="bg_color_1">

    {% include "_breadcrumbs.html.twig" %}

    <div class="collapse" id="collapseMap">
        <div id="map" class="map"></div>
    </div>
    <!-- End Map -->

    <div class="container margin_35_35">
        <div class="row">
            <aside class="col-lg-3">
                <div class="custom-search-input-2 inner-2">
                    <div class="form-group">
                        <input class="form-control" type="text" placeholder="Kamkoliv" id="autocomplete">
                        <i class="icon_pin_alt"></i>
                    </div>
                    <div class="form-group">
                        <input class="form-control" type="text" name="dates" placeholder="Kdykoliv">
                        <i class="icon_calendar"></i>
                    </div>
                    <input type="submit" class="btn_search" id="toursVolume" value="Ukázat 675 zájezdů">
                </div>
                <!-- /custom-search-input-2 -->
                <div id="filters_col">
                    <a data-toggle="collapse" href="#collapseFilters" aria-expanded="false"
                        aria-controls="collapseFilters" id="filters_col_bt">Filters </a>
                    <div class="collapse show" id="collapseFilters">

                        <div class="filter_type" id="tour_type_filter">
                            <h6>Typ Zájezdu</h6>
                            <ul>
                                {% for tourType in types %}
                                <li>
                                    <label class="container_check filter" id="tourTypeFilter_{{tourType.id}}">{{tourType.name}} <small>(945)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="filter_type" id="price_filter">
                            <h6>Cena</h6>
                            <input type="text" id="range" name="range" value="">
                            <div class="price_inputs">
                                <input class="form-control" type="text" id="range-min">
                                <span> - </span>
                                <input class="form-control" type="text" id="range-max">

                            </div>
                        </div>

                        <div class="filter_type" id="transport_filter">
                            <h6>Doprava</h6>
                            <ul>
                                {% for key,transport in transports %}
                                <li>
                                    <label class="container_check filter" id="transportFilter_{{key}}">{{transport}} <small>(945)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="filter_type" id="food_filter">
                            <h6>Strava</h6>
                            <ul>
                                {% for key,food in foods %}
                                <li>
                                    <label class="container_check filter" id="foodFilter_{{key}}">{{food}} <small>(945)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="filter_type" id="tour_length_filter">
                            <h6>Délka pobytu</h6>
                            <ul>
                                {% for len in tourLenght %}
                                <li>
                                    <label class="container_check">{{len}} <small>(945)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="filter_type" id="sales_filter">
                            <h6>Akce a slevy</h6>
                            <ul>
                                {% for sale in sales %}
                                <li>
                                    <label class="container_check">{{sale}} <small>(945)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <!--/collapse -->
                </div>
                <!--/filters col-->
            </aside>
            <!-- /aside -->

            <div class="col-lg-9" id="list_sidebar">
                <div class="list-header">
                    <h3>Nalezeno 567 zájezdů</h3>
                    <div class="switch-field">
                        <input type="radio" id="all" name="listing_filter" value="all" checked data-filter="*"
                            class="selected">
                        <label for="all">Nejprodávanější</label>
                        <input type="radio" id="popular" name="listing_filter" value="popular" data-filter=".popular">
                        <label for="popular">Nejlevnější</label>
                        <input type="radio" id="latest" name="listing_filter" value="latest" data-filter=".latest">
                        <label for="latest">Nejnovější</label>
                    </div>
                    <a class="btn_map" data-toggle="collapse" href="#collapseMap" aria-expanded="false"
                        aria-controls="collapseMap" data-text-swap="Hide map" data-text-original="View on map">View on
                        map</a>

                </div>

                <div class="isotope-wrapper">
                    {% for tour in tours %}
                        <div class="box_list isotope-item popular">
                            <div class="row no-gutters">
                                <div class="col-lg-5">
                                    <figure>
                                        <small>{{tour.type}}</small>
                                        <a href="../zajezdy/zobrazit/{{tour.escapedName}}/{{tour.id_zajezd}}">
                                            <img src="{{tour.image}}" class="img-fluid" alt="" width="800" height="533">

                                            {% if tour.priceDiscount > 0 %}
                                                <div class="price_discount_tag">
                                                    -{{tour.priceDiscount}}%
                                                </div>
                                            
                                            {% endif %}

                                            <div class="read_more"><span>Detail zájezdu</span></div>
                                        </a>
                                    </figure>
                                </div>
                                <div class="col-lg-7">
                                    <div class="wrapper">
                                        <a href="#0" class="wish_bt"></a>
                                        <h3><a href="/zajezdy/zobrazit/{{tour.escapedName}}/{{tour.id_zajezd}}">{{tour.name}}</a></h3>
                                        <p class="tour_destination">{{tour.destination}}</p>
                                        {# <p class="dates">12. - 14.6. 2023 <small>(+5 dalších termínů)</small></p> #}
                                        <div class="tour_list_feat2">
                                            <ul>
                                                {% for feature in tour.features %}
                                                    <li>
                                                        <span><i class="fas {{feature.icon}}"></i>{{feature.text|raw}}</span>
                                                    </li>
                                                {% endfor %}
                                            
                                            </ul>
                                        </div>
                                        <p class="tour_description">{{tour.description}}</p>
                                    </div>
                                    <ul class="footer">
                                        <li>
                                            {% if tour.priceDiscount > 0 %}
                                                <div class="price_discount">{{tour.priceOriginal}} Kč</div>
                                            {% endif %}
                                            <span class="price"><strong>{{tour.price}} Kč</strong> / os.</span>
                                            <span class="dates">12. - 14.6. 2023 <a href="">(+5 dalších termínů)</a></span>
                                        <li>
                                            <a href="../zajezdy/zobrazit/{{tour.escapedName}}/{{tour.id_zajezd}}" class="btn_1">Detail zájezdu</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}


                    <div class="box_list isotope-item popular">
                        <div class="row no-gutters">
                            <div class="col-lg-5">
                                <figure>
                                    <small>Historic</small>
                                    <a href="tour-detail.html"><img src="img/tour_1.jpg" class="img-fluid" alt=""
                                            width="800" height="533">
                                        <div class="read_more"><span>Read more</span></div>
                                    </a>
                                </figure>
                            </div>
                            <div class="col-lg-7">
                                <div class="wrapper">
                                    <a href="#0" class="wish_bt"></a>
                                    <h3><a href="tour-detail.html">Arc Triomphe</a></h3>
                                    <p>Dicam diceret ut ius, no epicuri dissentiet philosophia vix. Id usu zril
                                        tacimates neglegentur. Eam id legimus torquatos cotidieque, usu decore
                                        percipitur definitiones ex, nihil utinam recusabo mel no.</p>
                                    <span class="price">From <strong>$54</strong> /per person</span>
                                </div>
                                <ul>
                                    <li><i class="icon_clock_alt"></i> 1h 30min</li>
                                    <li>
                                        <div class="score"><span>Superb<em>350 Reviews</em></span><strong>8.9</strong>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <!-- /isotope-wrapper -->

                <p class="text-center add_top_30"><a href="#0" class="btn_1 rounded">Load more</a></p>
            </div>
            <!-- /col -->
        </div>
        <!-- /row -->
    </div>
</div>
<!-- /bg_color_1 -->



{% endblock main %}

{% block javascripts %}
    <script src="../js/range.js"></script>
    <script>        
        //TODO: selected filters udelat pristupne zvenku = inicialni nastaveni vyhledavani
        var selected_filters = ["txt_Lo","minPrice_100","maxPrice_20000"];
        

        async function getData(){
            
            var sz_res = await fetch('serial_zeme.json');
            var sz = await sz_res.json();
            
            var sd_res = await fetch('serial_destiance.json');
            var sd = await sd_res.json();

                                 
            var res = await fetch('data.json');
            var data = await res.json();
            data.forEach(function(elem,index,arr){
                let sID = elem["id_serial"];
                if (sz[sID]!= undefined){
                    elem.zName = sz[sID]["zName"];
                }
                if (sd[sID]!= undefined){
                    elem.dName = sd[sID]["dName"];
                }
                arr[index] = elem;
                //let zeme_ids = defiant.search(szSnapshot, '//*[id_serial='+id_serial+']/id_zeme');
                //let destinace_ids = defiant.search(szSnapshot, '//*[id_serial='+id_serial+']/id_destinace');
                //console.log(zeme_ids);
                
            });
            //TODO: data attribution nefunguje... mozna externi akumulator? nebo spatne props?
            return data;
        }
        
        function checkFilter(el){
            if($(el).find("input").is(":checked")){
                return $(el).attr('id');
            }
            return false;
        }
        
        function updateFilters(){
            var selected_filters = [];
            $(".filter").each(function(idx,el){
                let r = checkFilter(el);
                if(r){
                    selected_filters.push(r)
                }
            })
            
            selected_filters.push("txt_"+$("#autocomplete").val());
            selected_filters.push("minPrice_"+removeCurrency($("#range-min").val()));
            selected_filters.push("maxPrice_"+removeCurrency($("#range-max").val()));
            
            return selected_filters;
        }
                                              
        async function filterData(data,selected_filters){
            var filters = {tourTypeFilter:[],transportFilter:[],foodFilter:[],txt:[],minPrice:[],maxPrice:[]}
            selected_filters.forEach(f => {
                let arr = f.split("_");
                filters[arr[0]].push(arr[1]);
            
            });
            classFilters = {}
            if( filters.tourTypeFilter.length >0){
                classFilters["id_typ"] = filters.tourTypeFilter;
            }
            if( filters.transportFilter.length >0){
                classFilters["doprava"] = filters.transportFilter;
            }
            if( filters.foodFilter.length >0){
                classFilters["strava"] = filters.foodFilter;
            }
            
            var filteredData = await data
                    .then(data => itemsjs(data, 
                    {
                        sortings: {
                          termin_asc: {
                            field: 'do',
                            order: 'asc'
                          },
                          termin_desc: {
                            field: 'do',
                            order: 'desc'
                          }              
                        },
                        aggregations: {
                          id_typ: {
                            title: 'Typ zájezdu',
                            size: 15,
                            conjunction: false,
                            sort: "key",
                          },
                          strava: {
                            title: 'Typ stravování',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          },
                          doprava: {
                            title: 'Doprava',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          },    
                          ubytovani: {
                            title: 'Typ ubytování',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          }
                        },
                        searchableFields: ['nazev', 'nazev_ubytovani']
                    }))
                    .then(ijs => ijs.search(
                    {
                        per_page: 20,
                        page: 1,
                        sort: 'termin_asc',
                        query: filters.txt[0],
                        filters: classFilters,
                        filter: function(item) {
                            return item.castka >= parseInt(filters.minPrice[0]) && item.castka <= parseInt(filters.maxPrice[0]) && item.od >= "2022-11-01";
                        }

                    }));
              
            return filteredData;            
        }
        
        async function updateEnumElement(el,prefix){
            try{
                $("#"+prefix+"_"+el.key+" small").text("("+el.doc_count+")")
                if(el.selected==false){
                   $("#"+prefix+"_"+el.key+" input").prop("checked",false) 
                }else{
                   $("#"+prefix+"_"+el.key+" input").prop("checked",true)  
                }
                if(el.doc_count <= 0){
                    $("#"+prefix+"_"+el.key).css("font-style","italic");
                    $("#"+prefix+"_"+el.key).css("color","grey");
                    $("#"+prefix+"_"+el.key+" input").prop("disabled",true)                    
                }else{
                    $("#"+prefix+"_"+el.key).css("font-style","");
                    $("#"+prefix+"_"+el.key).css("color","");
                    $("#"+prefix+"_"+el.key+" input").prop("disabled",false)                    
                                    
                }
            }catch(err){
                
            }
        }
        
        async function updatePrice(min,max){
            try{
                updateInputs({from:min, to:max});
                instance = $range.data("ionRangeSlider");
                instance.update({
                    from: min,
                    to: max
                });
            }catch(err){
                console.log(err);
            }            
        }    
        
        async function updateTextSearch(text){
            try{
                $("#autocomplete").val(text)
            }catch(err){
                console.log(err);
            }            
        }  
        async function updateTotalTours(toursVolume){
            try{
                $("#toursVolume").val("Ukázat "+toursVolume+ " zájezdů");
            }catch(err){
                console.log(err);
            }            
        }  
        
        
        async function showData(filteredData,selected_filters){ 
            var filters = {tourTypeFilter:[],transportFilter:[],foodFilter:[],txt:[],minPrice:[],maxPrice:[]}
            selected_filters.forEach(f => {
                let arr = f.split("_");
                filters[arr[0]].push(arr[1]);
            
            });
            
            filteredData.then(fd => 
            {
                fd.data.aggregations.strava.buckets.forEach(el => updateEnumElement(el,"foodFilter"));
                fd.data.aggregations.doprava.buckets.forEach(el => updateEnumElement(el,"transportFilter"));
                fd.data.aggregations.id_typ.buckets.forEach(el => updateEnumElement(el,"tourTypeFilter"));
                updatePrice(filters.minPrice,filters.maxPrice);
                updateTextSearch(filters.txt);
                updateTotalTours(fd.pagination.total);
                console.dir(fd);
            }        
            );
        }
        
        
        $(function(){
            
            var data = getData();
            var filteredData = filterData(data,selected_filters);
            showData(filteredData,selected_filters);
            
            $(".form-control").change(function(){
                selected_filters = updateFilters();
                var filteredData = filterData(data, selected_filters);
                showData(filteredData,selected_filters);
            });
            $(".filter input").change(function(){
                selected_filters = updateFilters();
                var filteredData = filterData(data, selected_filters);
                showData(filteredData,selected_filters);                
            });
            
            
            
        });
        
        

        
        
        
    </script>    
{% endblock javascripts %}