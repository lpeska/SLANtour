{% extends "_base.html.twig" %}

{% block title %}SLANtour - {{ type.name }}{% endblock title %}

{% block stylesheets %}

{% endblock stylesheets %}

{% block main %}

<script src="/node_modules/itemsjs/dist/itemsjs.js"></script>
<section class="hero_in tour_list search">
    <img src="../img/dovolena.png" alt="Slide background">
    <div class="wrapper">
</section>
<!--/hero_in-->

<div class="bg_color_1">

    {% include "_breadcrumbs.html.twig" %}

    <div class="collapse" id="collapseMap">
        <div id="map" class="map"></div>
    </div>
    <!-- End Map -->

    <div class="container margin_35_35">
        <div class="row">
            <aside class="col-lg-3">
                <div class="custom-search-input-2 inner-2">
                    <div class="form-group">
                        <input class="form-control" type="text" placeholder="Kamkoliv" id="autocomplete">
                        <i class="icon_pin_alt"></i>
                    </div>
                    <div class="form-group">
                        <input class="form-control" type="text" id="datesInput" name="dates" placeholder="Kdykoliv">
                        <i class="icon_calendar"></i>
                    </div>
                    <input type="submit" class="btn_search" id="toursVolume" value="Ukázat 675 zájezdů">
                </div>
                <!-- /custom-search-input-2 -->
                <div id="filters_col">
                    <a data-toggle="collapse" href="#collapseFilters" aria-expanded="false"
                        aria-controls="collapseFilters" id="filters_col_bt">Filters </a>
                    <div class="collapse show" id="collapseFilters">

                        <div class="filter_type" id="tour_type_filter">
                            <h6>Typ Zájezdu</h6>
                            <ul>
                                {% for tourType in types %}
                                <li>
                                    <label class="container_check filter" id="tourTypeFilter_{{tourType.id}}">{{tourType.name}} <small>(0)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="filter_type" id="price_filter">
                            <h6>Cena</h6>
                            <input type="text" id="range" name="range" value="">
                            <div class="price_inputs">
                                <input class="form-control" type="text" id="range-min">
                                <span> - </span>
                                <input class="form-control" type="text" id="range-max">

                            </div>
                        </div>

                        <div class="filter_type" id="transport_filter">
                            <h6>Doprava</h6>
                            <ul>
                                {% for key,transport in transports %}
                                <li>
                                    <label class="container_check filter" id="transportFilter_{{key}}">{{transport}} <small>(0)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="filter_type" id="food_filter">
                            <h6>Strava</h6>
                            <ul>
                                {% for key,food in foods %}
                                <li>
                                    <label class="container_check filter" id="foodFilter_{{key}}">{{food}} <small>(0)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="filter_type" id="tour_length_filter">
                            <h6>Délka pobytu</h6>
                            <ul>
                                {% for key,len in tourLengths %}
                                <li>
                                    <label class="container_check filter" id="durGroupFilter_{{key}}">{{len}} <small>(0)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="filter_type" id="sales_filter">
                            <h6>Akce a slevy</h6>
                            <ul>
                                {% for sale in sales %}
                                <li>
                                    <label class="container_check">{{sale}} <small>(0)</small>
                                        <input type="checkbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <!--/collapse -->
                </div>
                <!--/filters col-->
            </aside>
            <!-- /aside -->

            <div class="col-lg-9" id="list_sidebar">
                <div class="list-header">
                    <h3>Nalezeno 0 zájezdů</h3>
                    <div class="switch-field">
                        <input type="radio" id="popular" name="listing_filter" value="popular" class="sorting-control" checked data-filter=".popular"
                            class="selected">
                        <label for="popular">Nejprodávanější</label>
                        <input type="radio" id="cheapest" name="listing_filter" value="cheapest" class="sorting-control" data-filter=".cheapest">
                        <label for="cheapest">Nejlevnější</label>
                        <input type="radio" id="closest" name="listing_filter" value="closest" class="sorting-control" data-filter=".closest">
                        <label for="closest">Nejbližší odjezd</label>
                        <input type="radio" id="latest" name="listing_filter" value="latest" class="sorting-control" data-filter=".latest">
                        <label for="latest">Nově přidané</label>
                    </div>
                    <a class="btn_map" data-toggle="collapse" href="#collapseMap" aria-expanded="false"
                        aria-controls="collapseMap" data-text-swap="Hide map" data-text-original="View on map">View on
                        map</a>

                </div>

                <div class="isotope-wrapper" id="tours_container">
                    {% for tour in tours %}
                        <div class="box_list isotope-item popular">
                            <div class="row no-gutters">
                                <div class="col-lg-5">
                                    <figure>
                                        <small>{{tour.type}}</small>
                                        <a href="../zajezdy/zobrazit/{{tour.escapedName}}/{{tour.id_zajezd}}">
                                            <img src="{{tour.image}}" class="img-fluid" alt="" width="800" height="533">

                                            {% if tour.priceDiscount > 0 %}
                                                <div class="price_discount_tag">
                                                    -{{tour.priceDiscount}}%
                                                </div>
                                            
                                            {% endif %}

                                            <div class="read_more"><span>Detail zájezdu</span></div>
                                        </a>
                                    </figure>
                                </div>
                                <div class="col-lg-7">
                                    <div class="wrapper">
                                        <a href="#0" class="wish_bt"></a>
                                        <h3><a href="/zajezdy/zobrazit/{{tour.escapedName}}/{{tour.id_zajezd}}">{{tour.name}}</a></h3>
                                        <p class="tour_destination">{{tour.destination}}</p>
                                        {# <p class="dates">12. - 14.6. 2023 <small>(+5 dalších termínů)</small></p> #}
                                        <div class="tour_list_feat2">
                                            <ul>
                                                {% for feature in tour.features %}
                                                    <li>
                                                        <span><i class="fas {{feature.icon}}"></i>{{feature.text|raw}}</span>
                                                    </li>
                                                {% endfor %}
                                            
                                            </ul>
                                        </div>
                                        <p class="tour_description">{{tour.description}}</p>
                                    </div>
                                    <ul class="footer">
                                        <li>
                                            {% if tour.priceDiscount > 0 %}
                                                {% if (tour.priceOriginal - tour.price) > 0 %}
                                                    <div class="price_discount">{{tour.priceOriginal}} Kč</div>
                                                {% endif %}
                                            {% endif %}
                                            <span class="price"><strong>{{tour.price}} Kč</strong> / os.</span>
                                            
                                            
                                            <span class="dates">{{ tour.dates }} 
                                                {% if tour.totalOtherDates > 0 %}
                                                    <a href="">(+ {{ tour.totalOtherDates }} dalších termínů)</a>
                                                {% endif %}
                                            </span>
                                        <li>
                                            <a href="../zajezdy/zobrazit/{{tour.escapedName}}/{{tour.id_zajezd}}" class="btn_1">Detail zájezdu</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}


                    <div class="box_list isotope-item popular">
                        <div class="row no-gutters">
                            <div class="col-lg-5">
                                <figure>
                                    <small>Historic</small>
                                    <a href="tour-detail.html"><img src="img/tour_1.jpg" class="img-fluid" alt=""
                                            width="800" height="533">
                                        <div class="read_more"><span>Read more</span></div>
                                    </a>
                                </figure>
                            </div>
                            <div class="col-lg-7">
                                <div class="wrapper">
                                    <a href="#0" class="wish_bt"></a>
                                    <h3><a href="tour-detail.html">Arc Triomphe</a></h3>
                                    <p>Dicam diceret ut ius, no epicuri dissentiet philosophia vix. Id usu zril
                                        tacimates neglegentur. Eam id legimus torquatos cotidieque, usu decore
                                        percipitur definitiones ex, nihil utinam recusabo mel no.</p>
                                    <span class="price">From <strong>$54</strong> /per person</span>
                                </div>
                                <ul>
                                    <li><i class="icon_clock_alt"></i> 1h 30min</li>
                                    <li>
                                        <div class="score"><span>Superb<em>350 Reviews</em></span><strong>8.9</strong>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <!-- /isotope-wrapper -->

                <p class="text-center add_top_30"><a href="#0" class="btn_1 rounded">Load more</a></p>
            </div>
            <!-- /col -->
        </div>
        <!-- /row -->
    </div>
</div>
<!-- /bg_color_1 -->



{% endblock main %}

{% block javascripts %}
    <script src="../js/range.js"></script>
    <script>        
        //TODO: selected filters udelat pristupne zvenku = inicialni nastaveni vyhledavani
        /*var selected_filters = ["txt_Lo","minPrice_100","maxPrice_20000"];*/        
        var selected_filters = [];
        
        async function getData(){
            
            var sz_res = await fetch('serial_zeme.json');
            var sz = await sz_res.json();
            
            var sd_res = await fetch('serial_destinace.json');
            var sd = await sd_res.json();
            
            var t_res = await fetch('tour_types.json');
            var t = await t_res.json();
            
            var sv_res = await fetch('sales_vol.json');
            var sv = await sv_res.json();
                                 
            var res = await fetch('data.json');
            var data = await res.json();
            data.forEach(function(elem,index,arr){
                data[index].castka = parseInt(data[index].castka);
                
                /*if (data[index].id_typ == "3" && data[index].nazev_ubytovani_web != undefined && data[index].nazev_ubytovani_web.length > 0){
                    data[index].escapedName = data[index].nazev_ubytovani_web + "-" + data[index].nazev_web;                    
                }else{
                    data[index].escapedName = data[index].nazev_web;
                }*/
                
                let sID = parseInt(elem["id_serial"]);
                if (sz[sID]!= undefined){
                    data[index].zName = sz[sID]["zName"];
                }else{
                    data[index].zName = "";
                }
                if (sv[sID]!= undefined){
                    var popularity = parseInt(sv[sID]["pocet"]) + Math.log2(sv[sID]["suma"]/1000)
                    data[index].popularity = popularity;
                }else{
                    data[index].popularity = 1;
                }
                
                if (sd[sID]!= undefined){
                    data[index].dName = sd[sID]["dName"];
                }else{
                    data[index].dName = "";
                }
                
                let tID = parseInt(elem["id_typ"]);
                if (t[tID]!= undefined){
                    data[index].tName = t[tID]["nazev_typ"];
                }else{
                    data[index].tName = "";
                }      
                
                if(elem["dlouhodobe_zajezdy"]=="1"){
                    data[index].durNights = -1;
                    data[index].durGroup = "variabilni";
                }else if(elem["od"] == elem["do"]){
                    data[index].durNights = 0;
                    data[index].durGroup = "jednodenni";
                }else{
                    var terminOd = new Date(elem["od"]);
                    var terminDo = new Date(elem["do"]);     
                    var diffDays = (terminDo.getTime() - terminOd.getTime()) / (1000 * 3600 * 24);
                    data[index].durNights = diffDays;
                    if(diffDays < 6){
                        data[index].durGroup = "1-5noci";
                    }else if(diffDays < 11){
                        data[index].durGroup = "6-10noci";                        
                    }else{
                        data[index].durGroup = "nad10noci";                        
                    }
                }

                
                //let zeme_ids = defiant.search(szSnapshot, '//*[id_serial='+id_serial+']/id_zeme');
                //let destinace_ids = defiant.search(szSnapshot, '//*[id_serial='+id_serial+']/id_destinace');
                //console.log(zeme_ids);
                
            });
            //TODO: data attribution nefunguje... mozna externi akumulator? nebo spatne props?
            return data;
        }
        
        function checkFilter(el){
            if($(el).find("input").is(":checked")){
                return $(el).attr('id');
            }
            return false;
        }
        
        function updateFilters(){
            var selected_filters = [];
            $(".filter").each(function(idx,el){
                let r = checkFilter(el);
                if(r){
                    selected_filters.push(r)
                }
            })
            
            selected_filters.push("txt_"+$("#autocomplete").val());
            selected_filters.push("minPrice_"+removeCurrency($("#range-min").val()));
            selected_filters.push("maxPrice_"+removeCurrency($("#range-max").val()));
            
            return selected_filters;
        }
                                              
        async function filterData(data,selected_filters){
            var filters = {tourTypeFilter:[],transportFilter:[],foodFilter:[],durGroupFilter:[],txt:[],minPrice:[],maxPrice:[]}
            selected_filters.forEach(f => {
                let arr = f.split("_");
                filters[arr[0]].push(arr[1]);
            
            });
            classFilters = {}
            if( filters.tourTypeFilter.length >0){
                classFilters["id_typ"] = filters.tourTypeFilter;
            }
            if( filters.transportFilter.length >0){
                classFilters["doprava"] = filters.transportFilter;
            }
            if( filters.foodFilter.length >0){
                classFilters["strava"] = filters.foodFilter;
            }
            
            if( filters.durGroupFilter.length >0){
                classFilters["durGroup"] = filters.durGroupFilter;
            }
            
            var sortParamInput = $('input[name="listing_filter"]:checked').val();
            var sortPar = 'termin_asc';
            if(sortParamInput == "popular"){
                var sortPar = 'popularity_desc';
            }else if(sortParamInput == "cheapest"){
                var sortPar = 'price_asc';
            }else if(sortParamInput == "closest"){
                var sortPar = 'termin_asc';
            }else if(sortParamInput == "latest"){
                var sortPar = 'zajezd_id_desc';
            }
            
            var filteredData = await data
                    .then(data => itemsjs(data, 
                    {
                        sortings: {
                          termin_asc: {
                            field: 'od',
                            order: 'asc'
                          },
                          termin_desc: {
                            field: 'od',
                            order: 'desc'
                          },
                          price_asc: {
                            field: 'castka',
                            order: 'asc'
                          },
                          price_desc: {
                            field: 'castka',
                            order: 'desc'
                          },     
                          zajezd_id_asc: {
                            field: 'id_zajezd',
                            order: 'asc'
                          },
                          zajezd_id_desc: {
                            field: 'id_zajezd',
                            order: 'desc'
                          },     
                          popularity_asc: {
                            field: 'popularity',
                            order: 'asc'
                          },
                          popularity_desc: {
                            field: 'popularity',
                            order: 'desc'
                          }                              
                        },
                        aggregations: {
                          id_typ: {
                            title: 'Typ zájezdu',
                            size: 15,
                            conjunction: false,
                            sort: "key",
                          },
                          strava: {
                            title: 'Typ stravování',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          },
                          doprava: {
                            title: 'Doprava',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          },   
                          durGroup: {
                            title: 'Délka pobytu',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          },                             
                          ubytovani: {
                            title: 'Typ ubytování',
                            size: 10,
                            conjunction: false,
                            sort: "key",
                          }
                        },
                        searchableFields: ['nazev', 'nazev_ubytovani',"zName","dName","tName"]
                    }))
                    .then(function(ijs){ 
                        
                        if (typeof filters.txt[0] !== "undefined"){
                        }
                           return ijs.search(                                      
                                {
                                    per_page: 20,
                                    page: 1,
                                    sort: sortPar,
                                    query: (typeof filters.txt[0] !== "undefined")? filters.txt[0]:"",
                                    filters: classFilters,
                                    filter: function(item) {
                                        var dates = $("#datesInput").val();
                                        var priceCheck = 1;
                                        var datesCheck = 1;
                                        
                                        if((typeof filters.minPrice[0] !== "undefined") && (typeof filters.maxPrice[0] !== "undefined") && parseInt(filters.maxPrice[0]) > 0){
                                            priceCheck = item.castka >= parseInt(filters.minPrice[0]) && item.castka <= parseInt(filters.maxPrice[0])
                                        }
                                        
                                        if(dates != ""){
                                            //add dates filter
                                            var datesArr = dates.split(" > ");
                                            var dateFrom = datesArr[0].split("/");
                                            var dateTo = datesArr[1].split("/");
                                            var dateFromEng = "20"+dateFrom[2]+"-"+dateFrom[1]+"-"+dateFrom[0];
                                            var dateToEng = "20"+dateTo[2]+"-"+dateTo[1]+"-"+dateTo[0];

                                            if(item.durNights == -1){
                                                datesCheck = item.do >= dateFromEng && item.od <= dateToEng && item.castka >= parseInt(filters.minPrice[0]) && item.castka <= parseInt(filters.maxPrice[0]);
                                            }else{                                    
                                                datesCheck = item.od >= dateFromEng && item.do <= dateToEng && item.castka >= parseInt(filters.minPrice[0]) && item.castka <= parseInt(filters.maxPrice[0]);
                                            } 
                                        }
                                        
                                        return datesCheck && priceCheck;
                                        
                                        //31/03/23 > 30/04/23
                                        //return item.castka >= parseInt(filters.minPrice[0]) && item.castka <= parseInt(filters.maxPrice[0]) && item.do >= "2022-11-01";
                                    }

                                });                                
                                
                            }
                        
                    );
              
            return filteredData;            
        }
        
        async function updateEnumElement(el,prefix){
            try{
                $("#"+prefix+"_"+el.key+" small").text("("+el.doc_count+")")
                if(el.selected==false){
                   $("#"+prefix+"_"+el.key+" input").prop("checked",false) 
                }else{
                   $("#"+prefix+"_"+el.key+" input").prop("checked",true)  
                }
                if(el.doc_count <= 0){
                    $("#"+prefix+"_"+el.key).css("font-style","italic");
                    $("#"+prefix+"_"+el.key).css("color","grey");
                    $("#"+prefix+"_"+el.key+" input").prop("disabled",true)                    
                }else{
                    $("#"+prefix+"_"+el.key).css("font-style","");
                    $("#"+prefix+"_"+el.key).css("color","");
                    $("#"+prefix+"_"+el.key+" input").prop("disabled",false)                    
                                    
                }
            }catch(err){
                
            }
        }
        
        async function updatePrice(min,max){
            try{
                updateInputs({from:min, to:max});
                instance = $range.data("ionRangeSlider");
                instance.update({
                    from: min,
                    to: max
                });
            }catch(err){
                console.log(err);
            }            
        }    
        
        async function updateTextSearch(text){
            try{
                $("#autocomplete").val(text)
            }catch(err){
                console.log(err);
            }            
        }  
        async function updateTotalTours(toursVolume){
            try{
                $("#toursVolume").val("Ukázat "+toursVolume+ " zájezdů");
            }catch(err){
                console.log(err);
            }            
        }  
        
        
        async function showData(filteredData,selected_filters){ 
            var filters = {tourTypeFilter:[],transportFilter:[],foodFilter:[],durGroupFilter:[],txt:[],minPrice:[],maxPrice:[]}
            selected_filters.forEach(f => {
                let arr = f.split("_");
                filters[arr[0]].push(arr[1]);
            
            });
            
            filteredData.then(fd => 
            {
                fd.data.aggregations.strava.buckets.forEach(el => updateEnumElement(el,"foodFilter"));
                fd.data.aggregations.doprava.buckets.forEach(el => updateEnumElement(el,"transportFilter"));
                fd.data.aggregations.id_typ.buckets.forEach(el => updateEnumElement(el,"tourTypeFilter"));
                fd.data.aggregations.durGroup.buckets.forEach(el => updateEnumElement(el,"durGroupFilter"));
                updatePrice(filters.minPrice,filters.maxPrice);
                updateTextSearch(filters.txt);
                updateTotalTours(fd.pagination.total);
                console.dir(fd);
                
                //load corresponding data and show them on appropriate location
                var dataAnchor = $("#tours_container");
                var toursToDisplay = fd.data.items;
                var ttdIDs = []
                var sIDs = []
                toursToDisplay.forEach(function(elem){
                    ttdIDs.push(elem.id_zajezd);
                    sIDs.push(elem.id_serial);
                });
                
                const formData = new FormData();
                formData.append("zajezdIDs", ttdIDs);  
                formData.append("serialIDs", sIDs);
                fetch("/ajax-load-data-for-vyhledat-zajezd.php", {
                    method: "POST",
                    body: formData,
                })
                .then((response) => response.text())
                .then((text) => {
                    dataAnchor.html(text);
                });
            }        
            );
        }
        
        
        $(function(){
            
            var data = getData();
            var filteredData = filterData(data,selected_filters);
            showData(filteredData,selected_filters);
            
            $(".form-control").change(function(){
                selected_filters = updateFilters();
                var filteredData = filterData(data, selected_filters);
                showData(filteredData,selected_filters);
            });
            
            $(".sorting-control").change(function(){
                selected_filters = updateFilters();
                var filteredData = filterData(data, selected_filters);
                showData(filteredData,selected_filters);
            });
            
            $(".filter input").change(function(){
                selected_filters = updateFilters();
                var filteredData = filterData(data, selected_filters);
                showData(filteredData,selected_filters);                
            });
            
            
            
        });
        
        

        
        
        
    </script>    
{% endblock javascripts %}